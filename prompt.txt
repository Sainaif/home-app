# 1. Product overview

* **Name:** Holy Home
* **Purpose:** Personal, self-hosted household management for shared bills, utilities, loans, chores, and forecasts.
* **Instance model:** Single household per instance.
* **Language:**

  * **UI:** Polish only (pl-PL).
  * **Logs:** English only.
* **No third-party integrations.**
* **SSL termination:** Outside the app (reverse proxy).
* **Admin bootstrap:** From `.env` (no public registration).
* **Predictions:** Server-side ML in a Python sidecar; Go API orchestrates; Mongo stores results; frontend displays.

# 2. Architecture

## 2.1 Components

* **Frontend:** Vue 3 + Vite + Pinia + Tailwind CSS, PWA, ECharts for charts, SSE client.
* **API:** Go + Fiber. REST + SSE. Auth (JWT), optional TOTP 2FA. Business logic, validation, orchestration.
* **DB:** MongoDB (wiredTiger), persistent volume.
* **ML sidecar:** Python + FastAPI. Time-series forecasting (SARIMAX/Holt-Winters) with selection & fallbacks.
* **Reverse proxy:** Out of scope (Traefik/NGINX recommended) for domain and TLS.

## 2.2 Runtime diagram (logical)

```
[Browser: Vue]  <-- REST/SSE -->  [Go API (Fiber)]  <--->  [MongoDB]
       |                                   |
       '------ REST (forecast req) --------'
                                           |
                                     [Python FastAPI ML]
```

# 3. Functional requirements

## 3.1 User & roles

* Admin created from `.env`.
* Admin creates users and optional groups (e.g. couples).
* Roles: `ADMIN`, `RESIDENT`.
* Optional TOTP 2FA toggle for the instance (per user secret if enabled).

## 3.2 Finance

* **Electricity:**

  * Admin enters bill: total kWh + total PLN + period.
  * Residents enter personal meter readings/units.
  * Split: personal usage cost + common area share (equal per unit: user or group) with optional weights.
  * Admin can override weights and allocations.
  * Periods: `draft → posted → closed`. Closed is immutable; corrections via adjustments.

* **Gas & Internet:**

  * Gas: equal split by default; optional per-usage if readings exist.
  * Internet: equal split.

* **Shared budget:**

  * Add purchases (PLN), optional receipt note, equal split.

* **Loans:**

  * Track `lender → borrower` with amount, status, partial repayments; maintain pairwise balances.

## 3.3 Household

* **Chores:**

  * Rotating schedule, manual swap, mark done, history.

* **Reminders:**

  * In-app notifications for readings, payments, chores. Pre-sets: 7d/3d/1d/overdue; custom dates optional.

## 3.4 Analytics & reporting

* Trends: daily/weekly/monthly/yearly averages; comparisons; unlimited history.
* Exports: CSV and PDF.

## 3.5 Predictions

* Targets: electricity, gas, shared budget.
* Triggered on bill/consumption change and by nightly job.
* Forecast horizon default 3 months (configurable).
* Confidence intervals shown in UI.

# 4. Non-functional requirements

* **Simplicity first** (personal use).
* **Availability:** restart-safe containers; healthchecks.
* **Performance:** p95 < 200 ms reads, < 500 ms writes on small data.
* **Security:** Argon2id passwords, JWT access/refresh, optional TOTP, rate limits (login).
* **Internationalisation:** UI copy Polish only; maintain `pl.json`.
* **Observability:** structured JSON logs in English; request IDs.

# 5. Security model

* **Auth:**

  * `POST /auth/login` → access + refresh tokens.
  * `POST /auth/refresh` rotates refresh token.
  * Store tokens in memory/localStorage (no cookies).

* **Passwords:**

  * `ADMIN_PASSWORD_HASH` in `.env` (Argon2id).
  * Users created by Admin; forced password change flow optional.

* **2FA (optional):**

  * TOTP secret per user; login accepts `totp` when enabled; QR provisioning endpoint.

* **RBAC:**

  * Route guards: `[ADMIN]` for config and posting/closing periods; `[AUTH]` for user operations.

* **Rate-limits:**

  * Login and refresh endpoints.

# 6. Data model (MongoDB collections)

Use Decimal128 for monies (PLN, 2 dp), and 3 dp for units.

* `users`

  * `_id`, `email` (unique), `password_hash`, `role`, `group_id?`, `totp_secret?`, `is_active`, `created_at`

* `groups`

  * `_id`, `name`, `weight` (float, default 1.0), `created_at`

* `bills`

  * `_id`, `type` ∈ {electricity, gas, internet, shared}, `period_start` (date), `period_end` (date),
    `total_amount_pln` (Decimal128), `total_units` (Decimal128), `notes?`, `status` ∈ {draft, posted, closed}, `created_at`

* `consumptions`

  * `_id`, `bill_id`, `user_id`, `units` (Decimal128), `meter_value?` (Decimal128), `recorded_at`, `source` ∈ {user, admin}

* `allocations`

  * `_id`, `bill_id`, `subject_type` ∈ {user, group}, `subject_id`, `amount_pln` (Decimal128), `units` (Decimal128),
    `method` ∈ {proportional, equal, weight, override}

* `payments`

  * `_id`, `bill_id`, `payer_user_id`, `amount_pln` (Decimal128), `paid_at`, `method?`, `reference?`

* `loans`

  * `_id`, `lender_id`, `borrower_id`, `amount_pln` (Decimal128), `status` ∈ {open, partial, settled}, `created_at`

* `loan_payments`

  * `_id`, `loan_id`, `amount_pln` (Decimal128), `paid_at`, `note?`

* `chores`

  * `_id`, `name`, `created_at`

* `chore_assignments`

  * `_id`, `chore_id`, `assignee_user_id`, `due_date`, `status` ∈ {pending, done}, `completed_at?`

* `notifications`

  * `_id`, `channel` ∈ {app}, `template_id`, `scheduled_for`, `sent_at?`, `status` ∈ {queued, sent}, `user_id?`

* `predictions`

  * `_id`, `target` ∈ {electricity, gas, shared_budget}, `period_start`, `period_end`, `horizon_months`,
    `predicted_units` (Decimal128), `predicted_amount_pln` (Decimal128),
    `model` { `name`, `version` }, `created_from` ∈ {bills, consumptions}, `created_at`

**Indexes:**

* `users.email` unique.
* `bills.type, bills.period_start`.
* `consumptions.bill_id`, `consumptions.user_id+recorded_at`.
* `allocations.bill_id+subject_type+subject_id`.
* `predictions.target+period_start`.

# 7. Allocation rules (electricity)

1. **Personal usage cost** = `user_units / sum_individual_units * cost_individual_pool`.
2. **Common area cost** = `common_pool / sum_weights * user_weight`.
3. **Admin overrides:** direct allocation rows; preserved as method `override`.
4. **Rounding:** banker's rounding, PLN to 2 dp, units to 3 dp.
5. **Period lock:**

   * `posted`: allocation frozen; edits require adjustment entries.
   * `closed`: immutable; only new period entries allowed.

# 8. Predictions design (server-side ML)

* **When:** On bill/consumption change and nightly at 02:00 local time (cron in Go).
* **How:** Go fetches series → calls ML sidecar → stores results → broadcasts SSE `prediction.updated`.
* **Targets & default horizon:**

  * Electricity, Gas: 3 months ahead (configurable).
  * Shared budget: 3 months.

**Model selection:**

* If series length ≥ 24 monthly points: **SARIMAX** (seasonal period 12) with small grid search; pick min-AIC.
* If 12 ≤ length < 24: **Holt-Winters (ExponentialSmoothing)** with additive trend/seasonality.
* If < 12: **Simple Exponential Smoothing** or **moving average**.
* Confidence intervals from model; if absent, estimate via residuals (empirical).

**Cost projection:**

* Predict units first.
* Estimate cost per unit as:

  * If last period has `total_amount_pln/total_units`, use that.
  * Else linear regression PLN ~ units on historical periods.
* `predicted_amount_pln = predicted_units * estimated_cost_per_unit`.

# 9. API contract (high-level)

## 9.1 Authentication

* `POST /auth/login` → `{ access, refresh }`

  * Input: `{ email, password, totp? }`
* `POST /auth/refresh` → `{ access, refresh }`
* `POST /auth/enable-2fa` [AUTH] → `{ otpauth_url, secret }`
* `POST /auth/disable-2fa` [AUTH]

## 9.2 Users & groups

* `GET /users` [ADMIN]
* `POST /users` [ADMIN] `{ email, role, groupId?, tempPassword? }`
* `PATCH /users/:id` [ADMIN]
* `POST /groups` [ADMIN] `{ name, weight }`
* `GET /groups` [AUTH]

## 9.3 Bills & consumptions

* `POST /bills` [ADMIN] `{ type, periodStart, periodEnd, totalAmountPLN, totalUnits, notes? }`
* `GET /bills?type=&from=&to=` [AUTH]
* `POST /consumptions` [AUTH] `{ billId, userId, units, meterValue?, recordedAt }`
* `POST /bills/:id/allocate` [ADMIN] `{ strategy: equal|proportional|weights|override, weights? }`
* `POST /bills/:id/post` [ADMIN]
* `POST /bills/:id/close` [ADMIN]

**Idempotency:** For POSTs that mutate finance, accept `Idempotency-Key` header.

## 9.4 Loans & payments

* `POST /loans` [AUTH] `{ lenderId, borrowerId, amountPLN, note? }`
* `POST /loan-payments` [AUTH] `{ loanId, amountPLN, paidAt }`
* `GET /balances` [AUTH] → pairwise owed/owing.

## 9.5 Chores & notifications

* `POST /chores` [ADMIN] `{ name }`
* `POST /chores/assign` [ADMIN] `{ choreId, assigneeUserId, dueDate }`
* `PATCH /chores/assign/:id` [AUTH] `{ status }`
* `GET /notifications` [AUTH]

## 9.6 Predictions & events

* `POST /predictions/recompute` [ADMIN] `{ target, horizon }`
* `GET /predictions?target=&from=&to=` [AUTH]
* `GET /events/stream` [AUTH] → SSE

**SSE event names:** `bill.created`, `consumption.created`, `prediction.updated`, `payment.created`, `chore.updated`.

# 10. Frontend specification (Vue 3)

* **Design:** Dark mode only; colours: black, purple `#9333ea`, pink `#ec4899`. Neon accents; clean, responsive.
* **Routing:** Login, Dashboard, Bills, Readings, Balance, Chores, Predictions, Settings.
* **State:** Pinia stores for auth, bills, consumptions, predictions, chores.
* **Charts:** ECharts with tooltips, confidence bands, Polish number/date formats.
* **Localisation:** Polish strings in `src/i18n/pl.json`.
* **SSE:** Connect after login; update charts on `prediction.updated`.

# 11. Logging (English)

* Structured JSON. Include: `ts`, `level`, `service`, `request_id`, `user_id?`, `route`, `latency_ms`, `error?`.
* ML sidecar logs model choice, AIC/fit stats, horizon, duration.

# 12. Configuration & environment

* `.env` controls ports, JWT, Mongo, ML base URL, 2FA toggle, admin bootstrap.
* Admin bootstrap runs once at API start if no admin exists.

# 13. Deployment (Docker Compose)

Use the following **full files** as starting points.

## 13.1 `.env.example` (full)

```dotenv
APP_NAME=Holy Home
APP_ENV=production
APP_HOST=0.0.0.0
APP_PORT=8080
APP_BASE_URL=https://holyhome.example.pl

# JWT
JWT_ACCESS_TTL=15m
JWT_REFRESH_TTL=720h
JWT_SECRET=change-this-access-secret
JWT_REFRESH_SECRET=change-this-refresh-secret

# Bootstrap admin (Argon2id hash generated offline)
ADMIN_EMAIL=admin@example.pl
ADMIN_PASSWORD_HASH=$argon2id$v=19$m=65536,t=3,p=1$CHANGE$THIS$HASH

# 2FA
AUTH_2FA_ENABLED=true

# Mongo
MONGO_URI=mongodb://mongo:27017
MONGO_DB=holyhome

# ML service
ML_BASE_URL=http://ml:8000
ML_TIMEOUT_SECONDS=30

# Logging
LOG_LEVEL=info
LOG_FORMAT=json
```

## 13.2 `deploy/docker-compose.yml` (full)

```yaml
services:
  api:
    build:
      context: ../backend
      dockerfile: Dockerfile
      args:
        - GO_VERSION=1.25
    env_file: .env
    depends_on:
      mongo:
        condition: service_healthy
      ml:
        condition: service_healthy
    ports:
      - "8080:8080"
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "wget", "-qO-", "http://localhost:8080/healthz"]
      interval: 30s
      timeout: 3s
      retries: 5

  ml:
    build:
      context: ../ml
      dockerfile: Dockerfile
      args:
        - PYTHON_VERSION=3.13
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "wget", "-qO-", "http://localhost:8000/healthz"]
      interval: 30s
      timeout: 3s
      retries: 5

  frontend:
    build:
      context: ../frontend
      dockerfile: Dockerfile
    depends_on:
      api:
        condition: service_started
    ports:
      - "5173:80"
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "wget", "-qO-", "http://localhost/"]
      interval: 30s
      timeout: 3s
      retries: 5

  mongo:
    image: mongodb/mongodb-community-server:8.0
    volumes:
      - mongo_data:/data/db
    restart: unless-stopped
    healthcheck:
      test: ["CMD-SHELL", "mongosh --quiet --eval 'db.runCommand({ ping: 1 }).ok' || exit 1"]
      interval: 30s
      timeout: 5s
      retries: 10

volumes:
  mongo_data:
```

# 14. Build artefacts (Dockerfiles & requirements)

> You will add code later; these **full files** build runnable containers once code exists.

## 14.1 `backend/Dockerfile` (full)

```dockerfile
# syntax=docker/dockerfile:1

ARG GO_VERSION=1.25
FROM golang:${GO_VERSION}-alpine AS builder

WORKDIR /src
RUN apk add --no-cache git ca-certificates tzdata build-base
COPY go.mod go.sum ./
RUN go mod download
COPY . .
# Build static binary
RUN CGO_ENABLED=0 GOOS=linux GOARCH=amd64 go build -ldflags="-s -w" -o /out/api ./cmd/api

FROM alpine:3.20
RUN addgroup -S app && adduser -S app -G app
WORKDIR /app
COPY --from=builder /out/api /app/api
COPY --from=builder /usr/share/zoneinfo /usr/share/zoneinfo
ENV TZ=Europe/Warsaw
USER app
EXPOSE 8080
ENTRYPOINT ["/app/api"]
```

## 14.2 `ml/Dockerfile` (full)

```dockerfile
# syntax=docker/dockerfile:1

ARG PYTHON_VERSION=3.13
FROM python:${PYTHON_VERSION}-slim

ENV PYTHONDONTWRITEBYTECODE=1 \
    PYTHONUNBUFFERED=1

WORKDIR /app
RUN apt-get update && apt-get install -y --no-install-recommends \
    build-essential gcc g++ \
    && rm -rf /var/lib/apt/lists/*

COPY requirements.txt .
RUN pip install --no-cache-dir -r requirements.txt

COPY app ./app
EXPOSE 8000
CMD ["python", "-m", "app.main"]
```

## 14.3 `ml/requirements.txt` (full)

```
fastapi==0.118.0
uvicorn[standard]==0.30.6
pydantic==2.9.2
numpy>=2.0.0
pandas>=2.2.0
scikit-learn==1.7.2
statsmodels==0.14.5
```

## 14.4 `frontend/Dockerfile` (full)

```dockerfile
# syntax=docker/dockerfile:1

FROM node:current-alpine AS build
WORKDIR /app
COPY package.json package-lock.json* pnpm-lock.yaml* yarn.lock* ./
RUN npm ci || npm install
COPY . .
RUN npm run build

FROM nginx:alpine
COPY --from=build /app/dist /usr/share/nginx/html
# Optional: custom nginx.conf for SPA routing
EXPOSE 80
CMD ["nginx", "-g", "daemon off;"]
```

# 15. Operations

* **Backups:** `mongodump` via external cron or a companion container; store to mounted volume; keep 30 days.
* **Restore drills:** test `mongorestore` monthly on a throwaway instance.
* **Rotate logs:** rely on container log driver with size limits.
* **Upgrades:** rebuild images to pick up latest minor library versions; run db backups first.

# 16. Testing

## 16.1 Unit (Go)

* Allocation maths: sum of allocations equals bill total within rounding tolerance.
* Loans: partial repayments keep consistent balances.
* Auth: JWT expiry/rotation; 2FA path.

## 16.2 Integration (Go + Mongo)

* Create bill → add consumptions → allocate → post → close → refusal to mutate closed.
* Prediction trigger stores prediction rows; SSE event emitted.

## 16.3 ML sidecar

* Model selection by series length; SARIMAX chosen for ≥24; Holt-Winters for mid; smoothing for short.
* CI for forecast reproducibility given fixed seeds.
* Confidence intervals non-negative; periods aligned monthly.

## 16.4 Frontend E2E (Cypress/Playwright)

* Login, navigate, add reading, observe updated forecast and dashboard totals.
* Visual check of confidence bands.

# 17. Acceptance criteria (Go/No-Go)

1. Admin bootstrapped from `.env` when no admin exists.
2. No public registration; Admin can create/disable users.
3. Electricity allocation = personal usage + common share (weights).
4. `posted` freezes allocations; `closed` is immutable; adjustments only via explicit entries.
5. Loans + partial repayments keep balances accurate.
6. Predictions recompute on data change and nightly; appear in UI with model & bands.
7. SSE updates trigger live chart refresh.
8. CSV/PDF exports reflect UI totals.
9. Logs are structured and in English; UI is fully Polish.
10. `docker compose up -d` brings all services healthy.

# 18. UI copy (Polish – examples)

* **Logowanie:** „Adres e-mail”, „Hasło”, „Kod 2FA”, „Zaloguj”.
* **Dashboard:** „Twoje saldo”, „Zbliżające się terminy”, „Dyżury”.
* **Rachunki:** „Nowy rachunek”, „Okres”, „Kwota (PLN)”, „Jednostki (kWh/m³)”, „Zapisz”, „Zamknij okres”.
* **Prognozy:** „Prognoza na 3 miesiące”, „Model”, „Przedział ufności”.
* **Powiadomienia:** „Przypomnienie o odczycie”, „Płatność do…”.

# 19. Coding standards

* **Go:** idiomatic, `golangci-lint`, context-aware handlers, request-scoped logger with request ID.
* **Python:** Pydantic schema validation, pure functions for model pipelines.
* **Vue:** script-setup, composables for API/SSE, Pinia modules per domain.
* **Commits:** conventional commits; small PRs per feature.

# 20. Delivery checklist

* [ ] Repo initialised with directories above.
* [ ] `.env` created from example with strong secrets and Argon2id hash for admin.
* [ ] `docker compose up -d` produces 3 green healthchecks.
* [ ] First login works; UI Polish; logs English.
* [ ] Create sample bill and readings; see forecast on Predictions page.
* [ ] Export CSV/PDF works.
