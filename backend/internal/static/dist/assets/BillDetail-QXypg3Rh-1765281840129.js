import{c as ae,i as ne,j as oe,z as re,r as i,o as ie,A as u,l as E,b as r,e as t,g as d,t as s,u as g,f as I,v as F,p as V,X as ue,q as B,E as de,y as ce,s as pe,F as q,h as z,m as me,d as o,n as be}from"./index-Hs7aDjjl-1765281840129.js";import{u as ve,D as ye}from"./useDataEvents-DV5fgDvx-1765281840129.js";import{C as fe}from"./circle-alert-BgqgMps3-1765281840129.js";/**
 * @license lucide-vue-next v0.544.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const G=ae("rotate-ccw",[["path",{d:"M3 12a9 9 0 1 0 9-9 9.75 9.75 0 0 0-6.74 2.74L3 8",key:"1357e3"}],["path",{d:"M3 3v5h5",key:"1xhq8a"}]]),he={class:"flex items-center justify-between mb-6"},_e={class:"flex items-center"},ge={class:"text-3xl font-bold"},$e={key:0,class:"text-center py-8"},ke={key:1,class:"text-center py-8 text-red-400"},xe={key:2},we={class:"card mb-6"},Ae={class:"text-xl font-semibold mb-4"},Se={class:"grid grid-cols-1 md:grid-cols-2 gap-4"},je={class:"text-gray-400"},De={class:"ml-2 font-medium"},Pe={class:"text-gray-400"},Re={class:"ml-2 font-medium"},Te={class:"text-gray-400"},Ie={class:"ml-2 font-medium"},Fe={class:"text-gray-400"},Ne={class:"ml-2 font-medium"},Le={key:0},Me={class:"text-gray-400"},Ue={class:"ml-2 font-medium"},Ce={key:1},Ee={class:"text-gray-400"},Ve={class:"ml-2 font-medium"},Be={key:2},qe={class:"text-gray-400"},ze={class:"ml-2 font-medium"},Ge={key:3,class:"md:col-span-2"},He={class:"text-gray-400"},Oe={class:"ml-2 font-medium"},We={class:"card max-w-md w-full mx-4"},Xe={class:"flex justify-between items-center mb-6"},Ye={class:"text-2xl font-bold gradient-text"},Je={class:"block text-sm font-medium mb-2"},Ke={value:"draft"},Qe={key:0,value:"posted"},Ze={class:"block text-sm font-medium mb-2"},et=["placeholder"],tt={key:0,class:"flex items-center gap-2 p-3 rounded-xl bg-red-500/10 border border-red-500/30 text-red-400 text-sm"},st={class:"flex gap-3"},lt=["disabled"],at={key:0,class:"loading-spinner"},nt={key:1,class:"card mb-6"},ot={class:"text-xl font-semibold mb-4"},rt={key:0,class:"text-center py-4"},it={key:1,class:"text-center py-4 text-gray-400"},ut={key:2,class:"grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-3"},dt={class:"flex justify-between items-start"},ct={class:"font-medium text-white"},pt={class:"text-xs text-gray-400"},mt={class:"text-right"},bt={class:"font-bold text-purple-400"},vt={key:0,class:"text-xs text-gray-400"},yt={key:0,class:"mt-2 pt-2 border-t border-gray-700/50 text-xs text-gray-400 space-y-1"},ft={class:"flex justify-between"},ht={class:"flex justify-between"},_t={class:"mt-2 pt-2 border-t border-gray-700/50"},gt={key:0},$t=["onClick"],kt={key:1,class:"text-center text-xs text-green-400"},xt={key:1,class:"text-center text-xs"},wt={key:0,class:"text-green-400"},At={key:1,class:"text-yellow-400"},St={key:2,class:"card mb-6"},jt={class:"text-xl font-semibold mb-4"},Dt={key:0,class:"text-center py-4"},Pt={key:1,class:"text-center py-4 text-gray-400"},Rt={key:2,class:"overflow-x-auto"},Tt={class:"w-full"},It={class:"border-b border-gray-700"},Ft={class:"text-left"},Nt={class:"pb-3"},Lt={class:"pb-3"},Mt={class:"pb-3"},Ut={class:"pb-3"},Ct={class:"pb-3"},Et={class:"py-3"},Vt={class:"py-3"},Bt={class:"py-3"},qt={class:"py-3"},zt={class:"py-3"},Gt=.01,Yt={__name:"BillDetail",setup(Ht){const{t:p,locale:N}=ne(),H=re();me();const v=oe(),{on:O}=ve(),c=H.params.id,n=i(null),j=i([]),m=i([]),$=i([]),L=i([]),k=i([]),D=i(!1),P=i(!1),R=i(!1),y=i(!1),h=i(!1),x=i(null),f=i({targetStatus:"draft",reason:""});ie(async()=>{D.value=!0;try{const[e,a,l]=await Promise.all([u.get(`/bills/${c}`),u.get("/users"),u.get("/groups")]);n.value=e.data,$.value=a.data||[],L.value=l.data||[],P.value=!0;const b=await u.get(`/consumptions?billId=${c}`);if(j.value=b.data||[],P.value=!1,n.value&&(n.value.status==="posted"||n.value.status==="closed")){R.value=!0;try{const[_,le]=await Promise.all([u.get(`/bills/${c}/allocation`),u.get(`/payments/bill/${c}`)]);m.value=_.data||[],k.value=le.data||[]}catch(_){console.error("Failed to load allocations:",_),m.value=[]}finally{R.value=!1}}}catch(e){console.error("Failed to load bill details:",e),n.value=null}finally{D.value=!1}O(ye.USER_UPDATED,async()=>{const e=await u.get("/users");$.value=e.data||[]})});function W(e){return e.type==="electricity"?p("bills.electricity"):e.type==="gas"?p("bills.gas"):e.type==="internet"?p("bills.internet"):e.type==="inne"&&e.customType?e.customType:e.type}function w(e){return e==="electricity"?"kWh":e==="gas"?"m³":p("readings.units")}function X(e,a){if(a==="group"){const l=L.value.find(b=>b.id===e);return l?l.name:p("errors.unknownGroup")}else{const l=$.value.find(b=>b.id===e);return l?l.name:p("errors.unknown")}}function A(e){return e?parseFloat(e.$numberDecimal||e||0).toFixed(2):"0.00"}function S(e){return e?parseFloat(e.$numberDecimal||e||0).toFixed(3):"0.000"}function T(e){if(!e)return"-";const l={pl:"pl-PL",en:"en-US"}[N.value]||"en-US";return new Date(e).toLocaleDateString(l)}function M(e){if(!e)return"-";const l={pl:"pl-PL",en:"en-US"}[N.value]||"en-US";return new Date(e).toLocaleString(l)}const U=E(()=>{if(!m.value||m.value.length===0||!v.user)return null;const e=v.user.id,a=v.user.groupId;return m.value.find(l=>!!(l.subjectType==="user"&&l.subjectId===e||l.subjectType==="group"&&a&&l.subjectId===a))||null}),Y=E(()=>U.value?C(U.value):!1);function J(e){return e.subjectType==="user"&&e.subjectId===v.user?.id||e.subjectType==="group"&&e.subjectId===v.user?.groupId}function C(e){const a=Number(e.amount||0);return a?K(e)+Gt>=a:!1}function K(e){const a=e.subjectType==="group"?Q(e.subjectId):[e.subjectId];return a.length?Z(a):0}function Q(e){return e?$.value.filter(a=>a.groupId===e).map(a=>a.id):[]}function Z(e){return!e.length||!Array.isArray(k.value)?0:k.value.reduce((a,l)=>(e.includes(l.payerUserId)&&(a+=ee(l.amountPLN)),a),0)}function ee(e){return e==null?0:typeof e=="number"?e:typeof e=="string"?parseFloat(e):typeof e=="object"&&e.$numberDecimal?parseFloat(e.$numberDecimal):0}async function te(e){try{const a=typeof e=="object"&&e.$numberDecimal?e.$numberDecimal:e.toString();await u.post("/payments/",{billId:c,amount:a}),alert(p("errors.paymentSuccess"));const l=await u.get(`/bills/${c}`);n.value=l.data;const[b,_]=await Promise.all([u.get(`/bills/${c}/allocation`),u.get(`/payments/bill/${c}`)]);m.value=b.data||[],k.value=_.data||[]}catch(a){console.error("Failed to mark as paid:",a),alert(p("errors.paymentFailed"))}}async function se(){h.value=!0,x.value=null;try{await u.post(`/bills/${c}/reopen`,f.value);const e=await u.get(`/bills/${c}`);n.value=e.data,y.value=!1,f.value={targetStatus:"draft",reason:""}}catch(e){x.value=e.response?.data?.error||p("errors.reopenFailed")}finally{h.value=!1}}return(e,a)=>(o(),r("div",null,[t("div",he,[t("div",_e,[t("button",{onClick:a[0]||(a[0]=l=>e.$router.back()),class:"btn btn-secondary mr-4"},"← "+s(e.$t("common.back")),1),t("h1",ge,s(e.$t("bills.billDetails")),1)]),g(v).isAdmin&&n.value&&(n.value.status==="posted"||n.value.status==="closed")?(o(),r("button",{key:0,onClick:a[1]||(a[1]=l=>y.value=!0),class:"btn btn-outline flex items-center gap-2"},[I(g(G),{class:"w-4 h-4"}),F(" "+s(e.$t("bills.changeStatus")),1)])):d("",!0)]),D.value?(o(),r("div",$e,s(e.$t("common.loading")),1)):n.value?(o(),r("div",xe,[t("div",we,[t("h2",Ae,s(e.$t("bills.billInfo")),1),t("div",Se,[t("div",null,[t("span",je,s(e.$t("bills.type"))+":",1),t("span",De,s(W(n.value)),1)]),t("div",null,[t("span",Pe,s(e.$t("common.status"))+":",1),t("span",Re,s(n.value.status),1)]),t("div",null,[t("span",Te,s(e.$t("bills.period"))+":",1),t("span",Ie,s(T(n.value.periodStart))+" - "+s(T(n.value.periodEnd)),1)]),t("div",null,[t("span",Fe,s(e.$t("bills.totalAmount"))+":",1),t("span",Ne,s(A(n.value.totalAmountPLN))+" PLN",1)]),n.value.totalUnits?(o(),r("div",Le,[t("span",Me,s(e.$t("bills.totalConsumption")),1),t("span",Ue,s(S(n.value.totalUnits))+" "+s(w(n.value.type)),1)])):d("",!0),n.value.paymentDeadline?(o(),r("div",Ce,[t("span",Ee,s(e.$t("bills.paymentDeadline"))+":",1),t("span",Ve,s(T(n.value.paymentDeadline)),1)])):d("",!0),n.value.reopenedAt?(o(),r("div",Be,[t("span",qe,s(e.$t("bills.reopened")),1),t("span",ze,s(M(n.value.reopenedAt)),1)])):d("",!0),n.value.reopenReason?(o(),r("div",Ge,[t("span",He,s(e.$t("bills.reopenReason")),1),t("span",Oe,s(n.value.reopenReason),1)])):d("",!0)])]),y.value?(o(),r("div",{key:0,class:"fixed inset-0 bg-black/50 backdrop-blur-sm flex items-center justify-center z-50",onClick:a[6]||(a[6]=V(l=>y.value=!1,["self"]))},[t("div",We,[t("div",Xe,[t("h2",Ye,s(e.$t("bills.changeStatus")),1),t("button",{onClick:a[2]||(a[2]=l=>y.value=!1),class:"text-gray-400 hover:text-white"},[I(g(ue),{class:"w-6 h-6"})])]),t("form",{onSubmit:V(se,["prevent"]),class:"space-y-4"},[t("div",null,[t("label",Je,s(e.$t("bills.targetStatus")),1),B(t("select",{"onUpdate:modelValue":a[3]||(a[3]=l=>f.value.targetStatus=l),required:"",class:"input"},[t("option",Ke,s(e.$t("bills.statusDraft")),1),n.value.status==="closed"?(o(),r("option",Qe,s(e.$t("bills.statusPosted")),1)):d("",!0)],512),[[de,f.value.targetStatus]])]),t("div",null,[t("label",Ze,s(e.$t("bills.reopenReasonLabel")),1),B(t("textarea",{"onUpdate:modelValue":a[4]||(a[4]=l=>f.value.reason=l),required:"",class:"input",rows:"3",placeholder:e.$t("bills.reopenReasonExample")},null,8,et),[[ce,f.value.reason]])]),x.value?(o(),r("div",tt,[I(g(fe),{class:"w-4 h-4"}),F(" "+s(x.value),1)])):d("",!0),t("div",st,[t("button",{type:"submit",disabled:h.value,class:"btn btn-primary flex-1 flex items-center justify-center gap-2"},[h.value?(o(),r("div",at)):(o(),pe(g(G),{key:1,class:"w-5 h-5"})),F(" "+s(h.value?e.$t("common.changing"):e.$t("bills.changeStatusButton")),1)],8,lt),t("button",{type:"button",onClick:a[5]||(a[5]=l=>y.value=!1),class:"btn btn-outline"},s(e.$t("common.cancel")),1)])],32)])])):d("",!0),n.value.status==="posted"||n.value.status==="closed"?(o(),r("div",nt,[t("h2",ot,s(e.$t("bills.costAllocationSection")),1),R.value?(o(),r("div",rt,s(e.$t("bills.loadingAllocationFull")),1)):m.value.length===0?(o(),r("div",it,s(e.$t("bills.noAllocationData")),1)):(o(),r("div",ut,[(o(!0),r(q,null,z(m.value,l=>(o(),r("div",{key:l.subjectId,class:"bg-gray-800/50 rounded-lg p-3 border border-gray-700/50"},[t("div",dt,[t("div",null,[t("p",ct,s(l.subjectName),1),t("p",pt,s(e.$t("bills.weight"))+" "+s(l.weight.toFixed(2)),1)]),t("div",mt,[t("p",bt,s(A(l.amount))+" PLN",1),l.units!==void 0?(o(),r("div",vt,s(S(l.units))+" "+s(w(n.value.type)),1)):d("",!0)])]),l.personalAmount!==void 0&&l.sharedAmount!==void 0?(o(),r("div",yt,[t("div",ft,[t("span",null,s(e.$t("bills.personal")),1),t("span",null,s(A(l.personalAmount))+" PLN",1)]),t("div",ht,[t("span",null,s(e.$t("bills.shared")),1),t("span",null,s(A(l.sharedAmount))+" PLN",1)])])):d("",!0),t("div",_t,[J(l)?(o(),r("div",gt,[Y.value?(o(),r("div",kt," ✓ "+s(e.$t("bills.paid")),1)):(o(),r("button",{key:0,onClick:b=>te(l.amount),class:"btn btn-primary w-full text-xs py-1"},s(e.$t("bills.markPaid")),9,$t))])):l.subjectType==="user"?(o(),r("div",xt,[C(l)?(o(),r("span",wt,"✓ "+s(e.$t("bills.paid")),1)):(o(),r("span",At,"⏳ "+s(e.$t("bills.pendingPayment")),1))])):d("",!0)])]))),128))]))])):d("",!0),n.value.type==="electricity"||n.value.type==="inne"&&n.value.allocationType==="metered"?(o(),r("div",St,[t("h2",jt,s(e.$t("readings.title")),1),P.value?(o(),r("div",Dt,s(e.$t("readings.loading")),1)):j.value.length===0?(o(),r("div",Pt,s(e.$t("readings.noReadings")),1)):(o(),r("div",Rt,[t("table",Tt,[t("thead",It,[t("tr",Ft,[t("th",Nt,s(e.$t("common.user")),1),t("th",Lt,s(e.$t("readings.reading")),1),t("th",Mt,s(e.$t("readings.consumption")),1),t("th",Ut,s(e.$t("common.date")),1),t("th",Ct,s(e.$t("readings.source")),1)])]),t("tbody",null,[(o(!0),r(q,null,z(j.value,l=>(o(),r("tr",{key:l.id,class:"border-b border-gray-700"},[t("td",Et,s(X(l.subjectId,l.subjectType)),1),t("td",Vt,s(S(l.meterValue))+" "+s(w(n.value.type)),1),t("td",Bt,s(S(l.units))+" "+s(w(n.value.type)),1),t("td",qt,s(M(l.recordedAt)),1),t("td",zt,[t("span",{class:be(l.source==="invalid"?"text-red-400":"text-gray-400")},s(l.source||"user"),3)])]))),128))])])]))])):d("",!0)])):(o(),r("div",ke,s(e.$t("errors.billNotFound")),1))]))}};export{Yt as default};
