import{i as ne,j as le,r as d,l as j,B as re,o as ie,a as de,b as n,e as t,g as p,t as o,F as g,h,u as w,q as m,E as k,y as I,p as E,n as f,A as x,d as l,v as M}from"./index-Hs7aDjjl-1765281840129.js";const ue={class:"text-3xl font-bold mb-8"},ce={class:"grid grid-cols-1 md:grid-cols-2 gap-6"},me={class:"card"},pe={class:"text-xl font-semibold mb-4 text-red-400"},ve={key:0,class:"text-center py-8"},be={key:1,class:"text-center py-8 text-gray-400"},ye={key:2,class:"space-y-3"},fe={key:0,class:"text-xs text-purple-400 ml-1"},ge={class:"font-bold text-red-400"},he={class:"card"},_e={class:"text-xl font-semibold mb-4 text-green-400"},$e={key:0,class:"text-center py-8"},we={key:1,class:"text-center py-8 text-gray-400"},ke={key:2,class:"space-y-3"},xe={key:0,class:"text-xs text-purple-400 ml-1"},Le={class:"font-bold text-green-400"},Pe={key:0,class:"grid grid-cols-1 md:grid-cols-2 gap-6 mt-6"},Ue={key:0,class:"card"},Ne={class:"text-xl font-semibold mb-4"},Ie={class:"block text-sm font-medium mb-2"},Se={value:""},De=["value"],Ae={class:"block text-sm font-medium mb-2"},Ce={value:""},Ve=["value"],Fe={class:"block text-sm font-medium mb-2"},Be={class:"block text-sm font-medium mb-2"},je={class:"block text-sm font-medium mb-2"},Me=["disabled"],Oe={key:1,class:"card"},qe={class:"text-xl font-semibold mb-4"},Ge={class:"block text-sm font-medium mb-2"},Ee={value:""},Ke=["value"],He={class:"block text-sm font-medium mb-2"},Te={class:"block text-sm font-medium mb-2"},Re={class:"block text-sm font-medium mb-2"},Ye=["disabled"],ze={class:"card mt-6"},Je={class:"space-y-3 mb-4"},Qe={class:"text-xl font-semibold"},We={class:"block text-sm font-medium mb-2"},Xe={value:""},Ze=["value"],et={class:"button-group grid-cols-4"},tt={class:"grid grid-cols-1 md:grid-cols-3 gap-3"},st={class:"block text-sm font-medium mb-2"},at={value:"createdAt"},ot={value:"amountPLN"},nt={value:"status"},lt={value:"remainingPLN"},rt={class:"block text-sm font-medium mb-2"},it={value:"desc"},dt={value:"asc"},ut={class:"block text-sm font-medium mb-2"},ct={value:0},mt={key:0,class:"text-center py-8"},pt={key:1,class:"text-center py-8 text-gray-400"},vt={key:2,class:"overflow-x-auto"},bt={class:"w-full"},yt={class:"border-b border-gray-700"},ft={class:"text-left"},gt={class:"pb-3"},ht={class:"pb-3"},_t={class:"pb-3"},$t={class:"pb-3"},wt={class:"pb-3"},kt={class:"pb-3"},xt={class:"pb-3"},Lt={key:0,class:"pb-3"},Pt=["onClick"],Ut={class:"py-3"},Nt={class:"flex items-center gap-2"},It={key:0,class:"text-xs text-purple-400 ml-1"},St={class:"py-3"},Dt={key:0,class:"text-xs text-purple-400 ml-1"},At={class:"py-3"},Ct={class:"py-3 text-gray-400"},Vt={class:"py-3"},Ft={class:"py-3"},Bt=["onClick","title"],jt={key:0,class:"border-b border-gray-700 bg-gray-800"},Mt=["colspan"],Ot={class:"ml-8"},qt={class:"text-sm font-semibold mb-3 text-purple-300"},Gt={key:0,class:"text-gray-400 text-sm italic"},Et={key:1,class:"space-y-2"},Kt={class:"flex items-center gap-3"},Ht={class:"text-gray-300"},Tt={key:0,class:"px-2 py-1 bg-purple-600 text-purple-100 text-xs rounded-full font-medium"},Rt={key:0,class:"text-gray-400 italic text-xs"},Jt={__name:"Balance",setup(Yt){const{t:L,locale:z}=ne(),v=le(),P=d([]),_=d([]),U=d([]),S=d(!1),C=d(!1),V=d(!1),b=d("all"),D=d(""),O=d("createdAt"),q=d("desc"),F=d(50),A=d(null),N=d({}),r=d({lenderId:"",borrowerId:"",amount:"",note:"",dueDate:""}),u=d({loanId:"",amount:"",paidAt:new Date().toISOString().slice(0,16),note:""}),K=j(()=>Array.isArray(P.value)?P.value.filter(e=>e.fromUserId===v.user?.id):[]),H=j(()=>Array.isArray(P.value)?P.value.filter(e=>e.toUserId===v.user?.id):[]),J=j(()=>Array.isArray(_.value)?_.value.filter(e=>e.status==="open"||e.status==="partial"):[]),T=j(()=>{if(!Array.isArray(_.value))return[];let e=_.value;return b.value!=="all"&&(e=e.filter(a=>a.status===b.value)),D.value&&(e=e.filter(a=>a.lenderId===D.value||a.borrowerId===D.value)),e});async function B(){try{const e=new URLSearchParams({sort:O.value,order:q.value});F.value>0&&(e.append("limit",F.value.toString()),e.append("offset","0"));const a=await x.get(`/loans?${e.toString()}`);_.value=a.data||[]}catch(e){console.error("Failed to load loans:",e),_.value=[]}}async function c(){try{const e=[x.get("/loans/balances/me"),B()];v.hasPermission("loans.create")&&e.push(x.get("/users"));const a=await Promise.all(e);P.value=a[0].data||[],v.hasPermission("loans.create")&&(U.value=a[2].data||[])}catch(e){console.error("Failed to load balance data:",e),P.value=[],_.value=[]}}const y=re(),R=()=>{document.visibilityState==="visible"&&(console.log("[Balance] Tab visible, reloading data"),c())};ie(async()=>{S.value=!0,await c(),S.value=!1,y.connect(),y.on("loan.created",()=>{console.log("[Balance] Loan created event received, reloading data"),c()}),y.on("loan.payment.created",()=>{console.log("[Balance] Loan payment event received, reloading data"),c()}),y.on("loan.deleted",()=>{console.log("[Balance] Loan deleted event received, reloading data"),c()}),y.on("balance.updated",()=>{console.log("[Balance] Balance updated event received, reloading data"),c()}),document.addEventListener("visibilitychange",R)}),de(()=>{y.off("loan.created",c),y.off("loan.payment.created",c),y.off("loan.deleted",c),y.off("balance.updated",c),y.disconnect(),document.removeEventListener("visibilitychange",R)});async function Q(){C.value=!0;try{await x.post("/loans",{lenderId:r.value.lenderId,borrowerId:r.value.borrowerId,amountPLN:r.value.amount,note:r.value.note||void 0,dueDate:r.value.dueDate?new Date(r.value.dueDate).toISOString():void 0}),r.value={lenderId:"",borrowerId:"",amount:"",note:"",dueDate:""},await c()}catch(e){console.error("Failed to create loan:",e),alert(L("errors.createLoanFailed")+" "+(e.response?.data?.error||e.message))}finally{C.value=!1}}async function W(){V.value=!0;try{await x.post("/loan-payments",{loanId:u.value.loanId,amountPLN:u.value.amount,paidAt:new Date(u.value.paidAt).toISOString(),note:u.value.note||void 0}),u.value={loanId:"",amount:"",paidAt:new Date().toISOString().slice(0,16),note:""},await c()}catch(e){console.error("Failed to create payment:",e),alert(L("errors.createPaymentFailed")+" "+(e.response?.data?.error||e.message))}finally{V.value=!1}}function X(e){const a=U.value.find(G=>G.id===e.lenderId),s=U.value.find(G=>G.id===e.borrowerId),i=$(e.amountPLN),oe=e.remainingPLN?$(e.remainingPLN):i;return e.status==="partial"?`${a?.name||"?"} → ${s?.name||"?"} (${L("balance.remainingOf",{remaining:oe,total:i})})`:`${a?.name||"?"} → ${s?.name||"?"} (${i} PLN)`}function $(e){return e?typeof e=="number"?e.toFixed(2):parseFloat(e.$numberDecimal||e||0).toFixed(2):"0.00"}function Y(e){const s={pl:"pl-PL",en:"en-US"}[z.value]||"en-US";return new Date(e).toLocaleDateString(s)}function Z(e){const a={open:"balance.statusOpen",partial:"balance.statusPartial",settled:"balance.statusSettled"};return a[e]?L(a[e]):e}function ee(e){return{open:"text-red-400",partial:"text-yellow-400",settled:"text-green-400"}[e]||"text-gray-400"}function te(e){return e.status==="settled"?"text-green-400":e.status==="partial"?"text-yellow-400":"text-red-400"}async function se(e){if(A.value===e)A.value=null;else if(A.value=e,!N.value[e])try{const a=await x.get(`/loans/${e}/payments`);N.value[e]=a.data||[]}catch(a){console.error("Failed to load loan payments:",a),N.value[e]=[]}}async function ae(e){if(confirm(L("balance.confirmDelete")))try{await x.delete(`/loans/${e}`),await c()}catch(a){console.error("Failed to delete loan:",a),alert(L("errors.deleteLoanFailed")+" "+(a.response?.data?.error||a.message))}}return(e,a)=>(l(),n("div",null,[t("h1",ue,o(e.$t("balance.title")),1),t("div",ce,[t("div",me,[t("h2",pe,o(e.$t("balance.youOwe")),1),S.value?(l(),n("div",ve,o(e.$t("common.loading")),1)):K.value.length===0?(l(),n("div",be,o(e.$t("balance.settled")),1)):(l(),n("div",ye,[(l(!0),n(g,null,h(K.value,s=>(l(),n("div",{key:`${s.fromUserId}-${s.toUserId}`,class:"flex justify-between items-center p-3 bg-gray-700 rounded"},[t("span",null,[M(o(s.toUserName)+" ",1),s.toUserGroupName?(l(),n("span",fe,"("+o(s.toUserGroupName)+")",1)):p("",!0)]),t("span",ge,o($(s.netAmount))+" PLN",1)]))),128))]))]),t("div",he,[t("h2",_e,o(e.$t("balance.owesYou")),1),S.value?(l(),n("div",$e,o(e.$t("common.loading")),1)):H.value.length===0?(l(),n("div",we,o(e.$t("balance.settled")),1)):(l(),n("div",ke,[(l(!0),n(g,null,h(H.value,s=>(l(),n("div",{key:`${s.fromUserId}-${s.toUserId}`,class:"flex justify-between items-center p-3 bg-gray-700 rounded"},[t("span",null,[M(o(s.fromUserName)+" ",1),s.fromUserGroupName?(l(),n("span",xe,"("+o(s.fromUserGroupName)+")",1)):p("",!0)]),t("span",Le,o($(s.netAmount))+" PLN",1)]))),128))]))])]),w(v).hasPermission("loans.create")||w(v).hasPermission("loan-payments.create")?(l(),n("div",Pe,[w(v).hasPermission("loans.create")?(l(),n("div",Ue,[t("h2",Ne,o(e.$t("balance.addLoan")),1),t("form",{onSubmit:E(Q,["prevent"]),class:"space-y-4"},[t("div",null,[t("label",Ie,o(e.$t("balance.lender")),1),m(t("select",{"onUpdate:modelValue":a[0]||(a[0]=s=>r.value.lenderId=s),required:"",class:"input"},[t("option",Se,o(e.$t("common.select")),1),(l(!0),n(g,null,h(U.value,s=>(l(),n("option",{key:s.id,value:s.id},o(s.name),9,De))),128))],512),[[k,r.value.lenderId]])]),t("div",null,[t("label",Ae,o(e.$t("balance.borrower")),1),m(t("select",{"onUpdate:modelValue":a[1]||(a[1]=s=>r.value.borrowerId=s),required:"",class:"input"},[t("option",Ce,o(e.$t("common.select")),1),(l(!0),n(g,null,h(U.value,s=>(l(),n("option",{key:s.id,value:s.id},o(s.name),9,Ve))),128))],512),[[k,r.value.borrowerId]])]),t("div",null,[t("label",Fe,o(e.$t("balance.amount"))+" (PLN)",1),m(t("input",{"onUpdate:modelValue":a[2]||(a[2]=s=>r.value.amount=s),type:"number",step:"0.01",required:"",class:"input"},null,512),[[I,r.value.amount,void 0,{number:!0}]])]),t("div",null,[t("label",Be,o(e.$t("common.noteOptional")),1),m(t("input",{"onUpdate:modelValue":a[3]||(a[3]=s=>r.value.note=s),type:"text",class:"input"},null,512),[[I,r.value.note]])]),t("div",null,[t("label",je,o(e.$t("balance.dueDate")),1),m(t("input",{"onUpdate:modelValue":a[4]||(a[4]=s=>r.value.dueDate=s),type:"date",class:"input"},null,512),[[I,r.value.dueDate]])]),t("button",{type:"submit",disabled:C.value,class:"btn btn-primary w-full"},o(C.value?e.$t("common.adding"):e.$t("balance.addLoan")),9,Me)],32)])):p("",!0),w(v).hasPermission("loan-payments.create")?(l(),n("div",Oe,[t("h2",qe,o(e.$t("balance.addPayment")),1),t("form",{onSubmit:E(W,["prevent"]),class:"space-y-4"},[t("div",null,[t("label",Ge,o(e.$t("balance.loan")),1),m(t("select",{"onUpdate:modelValue":a[5]||(a[5]=s=>u.value.loanId=s),required:"",class:"input"},[t("option",Ee,o(e.$t("common.select")),1),(l(!0),n(g,null,h(J.value,s=>(l(),n("option",{key:s.id,value:s.id},o(X(s)),9,Ke))),128))],512),[[k,u.value.loanId]])]),t("div",null,[t("label",He,o(e.$t("balance.amount"))+" (PLN)",1),m(t("input",{"onUpdate:modelValue":a[6]||(a[6]=s=>u.value.amount=s),type:"number",step:"0.01",required:"",class:"input"},null,512),[[I,u.value.amount,void 0,{number:!0}]])]),t("div",null,[t("label",Te,o(e.$t("balance.paymentDate")),1),m(t("input",{"onUpdate:modelValue":a[7]||(a[7]=s=>u.value.paidAt=s),type:"datetime-local",required:"",class:"input"},null,512),[[I,u.value.paidAt]])]),t("div",null,[t("label",Re,o(e.$t("common.noteOptional")),1),m(t("input",{"onUpdate:modelValue":a[8]||(a[8]=s=>u.value.note=s),type:"text",class:"input"},null,512),[[I,u.value.note]])]),t("button",{type:"submit",disabled:V.value,class:"btn btn-primary w-full"},o(V.value?e.$t("common.adding"):e.$t("balance.addPayment")),9,Ye)],32)])):p("",!0)])):p("",!0),t("div",ze,[t("div",Je,[t("h2",Qe,o(e.$t("balance.loanHistory")),1),t("div",null,[t("label",We,o(e.$t("balance.filterByUser")),1),m(t("select",{"onUpdate:modelValue":a[9]||(a[9]=s=>D.value=s),class:"input mb-3"},[t("option",Xe,o(e.$t("balance.allUsers")),1),(l(!0),n(g,null,h(U.value,s=>(l(),n("option",{key:s.id,value:s.id},o(s.name),9,Ze))),128))],512),[[k,D.value]])]),t("div",et,[t("button",{onClick:a[10]||(a[10]=s=>b.value="all"),class:f([b.value==="all"?"btn-primary":"btn-outline","btn btn-sm"])},o(e.$t("common.all")),3),t("button",{onClick:a[11]||(a[11]=s=>b.value="open"),class:f([b.value==="open"?"btn-primary":"btn-outline","btn btn-sm"])},o(e.$t("balance.unpaid")),3),t("button",{onClick:a[12]||(a[12]=s=>b.value="partial"),class:f([b.value==="partial"?"btn-primary":"btn-outline","btn btn-sm"])},o(e.$t("balance.partial")),3),t("button",{onClick:a[13]||(a[13]=s=>b.value="settled"),class:f([b.value==="settled"?"btn-primary":"btn-outline","btn btn-sm"])},o(e.$t("balance.settled")),3)]),t("div",tt,[t("div",null,[t("label",st,o(e.$t("balance.sortBy")),1),m(t("select",{"onUpdate:modelValue":a[14]||(a[14]=s=>O.value=s),onChange:B,class:"input"},[t("option",at,o(e.$t("balance.createdDate")),1),t("option",ot,o(e.$t("balance.amount")),1),t("option",nt,o(e.$t("common.status")),1),t("option",lt,o(e.$t("balance.remaining")),1)],544),[[k,O.value]])]),t("div",null,[t("label",rt,o(e.$t("balance.order")),1),m(t("select",{"onUpdate:modelValue":a[15]||(a[15]=s=>q.value=s),onChange:B,class:"input"},[t("option",it,o(e.$t("common.descending")),1),t("option",dt,o(e.$t("common.ascending")),1)],544),[[k,q.value]])]),t("div",null,[t("label",ut,o(e.$t("balance.show")),1),m(t("select",{"onUpdate:modelValue":a[16]||(a[16]=s=>F.value=s),onChange:B,class:"input"},[a[18]||(a[18]=t("option",{value:10},"10",-1)),a[19]||(a[19]=t("option",{value:25},"25",-1)),a[20]||(a[20]=t("option",{value:50},"50",-1)),a[21]||(a[21]=t("option",{value:100},"100",-1)),t("option",ct,o(e.$t("common.all")),1)],544),[[k,F.value]])])])]),S.value?(l(),n("div",mt,o(e.$t("common.loading")),1)):T.value.length===0?(l(),n("div",pt,o(e.$t("balance.noHistory")),1)):(l(),n("div",vt,[t("table",bt,[t("thead",yt,[t("tr",ft,[t("th",gt,o(e.$t("balance.from")),1),t("th",ht,o(e.$t("balance.to")),1),t("th",_t,o(e.$t("balance.amount")),1),t("th",$t,o(e.$t("balance.remaining")),1),t("th",wt,o(e.$t("common.description")),1),t("th",kt,o(e.$t("common.status")),1),t("th",xt,o(e.$t("common.date")),1),w(v).hasPermission("loans.delete")?(l(),n("th",Lt,o(e.$t("common.actions")),1)):p("",!0)])]),t("tbody",null,[(l(!0),n(g,null,h(T.value,s=>(l(),n(g,{key:s.id},[t("tr",{class:"border-b border-gray-700 hover:bg-gray-750 cursor-pointer",onClick:i=>se(s.id)},[t("td",Ut,[t("span",Nt,[(l(),n("svg",{xmlns:"http://www.w3.org/2000/svg",class:f(["w-4 h-4 transition-transform",A.value===s.id?"rotate-90":""]),viewBox:"0 0 24 24",fill:"none",stroke:"currentColor","stroke-width":"2","stroke-linecap":"round","stroke-linejoin":"round"},[...a[22]||(a[22]=[t("path",{d:"m9 18 6-6-6-6"},null,-1)])],2)),M(" "+o(s.fromUserName)+" ",1),s.fromUserGroupName?(l(),n("span",It,"("+o(s.fromUserGroupName)+")",1)):p("",!0)])]),t("td",St,[M(o(s.toUserName)+" ",1),s.toUserGroupName?(l(),n("span",Dt,"("+o(s.toUserGroupName)+")",1)):p("",!0)]),t("td",At,o($(s.amountPLN))+" PLN",1),t("td",{class:f(["py-3",te(s)])},o($(s.remainingPLN))+" PLN ",3),t("td",Ct,o(s.note||"-"),1),t("td",Vt,[t("span",{class:f(ee(s.status))},o(Z(s.status)),3)]),t("td",Ft,o(Y(s.createdAt)),1),w(v).hasPermission("loans.delete")?(l(),n("td",{key:0,class:"py-3",onClick:a[17]||(a[17]=E(()=>{},["stop"]))},[t("button",{onClick:i=>ae(s.id),class:"btn btn-sm btn-secondary",title:e.$t("balance.deleteLoan")},[...a[23]||(a[23]=[t("svg",{xmlns:"http://www.w3.org/2000/svg",class:"w-4 h-4",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor","stroke-width":"2","stroke-linecap":"round","stroke-linejoin":"round"},[t("path",{d:"M3 6h18"}),t("path",{d:"M19 6v14c0 1-1 2-2 2H7c-1 0-2-1-2-2V6"}),t("path",{d:"M8 6V4c0-1 1-2 2-2h4c1 0 2 1 2 2v2"})],-1)])],8,Bt)])):p("",!0)],8,Pt),A.value===s.id?(l(),n("tr",jt,[t("td",{colspan:w(v).hasPermission("loans.delete")?8:7,class:"py-3 px-6"},[t("div",Ot,[t("h4",qt,o(e.$t("balance.paymentHistory")),1),!N.value[s.id]||N.value[s.id].length===0?(l(),n("div",Gt,o(e.$t("balance.noPayments")),1)):(l(),n("div",Et,[(l(!0),n(g,null,h(N.value[s.id],i=>(l(),n("div",{key:i.id,class:f(["flex items-center justify-between p-3 rounded text-sm",i.note==="Kompensacja grupowa"?"bg-purple-900 bg-opacity-30 border border-purple-500":"bg-gray-750"])},[t("div",Kt,[(l(),n("svg",{xmlns:"http://www.w3.org/2000/svg",class:f(["w-4 h-4",i.note==="Kompensacja grupowa"?"text-purple-400":"text-green-400"]),viewBox:"0 0 24 24",fill:"none",stroke:"currentColor","stroke-width":"2","stroke-linecap":"round","stroke-linejoin":"round"},[...a[24]||(a[24]=[t("path",{d:"M20 6 9 17l-5-5"},null,-1)])],2)),t("span",{class:f(["font-medium",i.note==="Kompensacja grupowa"?"text-purple-400":"text-green-400"])},o($(i.amountPLN))+" PLN",3),a[25]||(a[25]=t("span",{class:"text-gray-400"},"•",-1)),t("span",Ht,o(Y(i.paidAt)),1),i.note==="Kompensacja grupowa"?(l(),n("span",Tt,o(e.$t("balance.compensation")),1)):p("",!0)]),i.note&&i.note!=="Kompensacja grupowa"?(l(),n("div",Rt,o(i.note),1)):p("",!0)],2))),128))]))])],8,Mt)])):p("",!0)],64))),128))])])]))])]))}};export{Jt as default};
